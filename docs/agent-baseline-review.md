# Проверка соответствия базовым правилам агентских систем

Этот документ фиксирует текущее соответствие проекта базовым принципам построения агентских систем (prompt chaining, routing, параллелизм, reflection, tool use, planning, multi-agent, память, адаптация, MCP, цели и мониторинг, восстановление после ошибок, human-in-the-loop, RAG, прод‑слой). Оценка основана на обзоре исходников `src/AiTextEditor.Lib` и `src/AiTextEditor.SemanticKernel`.

## 1. Prompt Chaining
- **Наличие:** выходные контракты для курсорного агента описаны как JSON-схемы в `CursorAgentPromptBuilder` (команды сканирования и финализатор). Агент собирает структурированные `EvidenceItem` и передаёт их финализатору для выбора результата.
- **Пробелы:** отсутствуют формализованные структуры для общесистемных шагов (intent, inputs_needed, risks); нет кеша или дедупликации повторяющихся подзадач; стоп‑критерии есть только в лимитах шагов и флаге `MaxEvidenceCount`, но не управляются централизованно.

## 2. Routing
- **Наличие:** специализированные курсоры (keyword/query) предоставляют ручную маршрутизацию по типу запроса.
- **Пробелы:** нет явного роутера с меткой, уверенностью и fallback‑политикой; выбор модели/глубины рассуждения не завязан на бюджет или риск; опасные действия не выделены в отдельный маршрут.

## 3. Parallelization
- **Наличие:** не реализовано.
- **Пробелы:** нет map‑reduce слоя, спекулятивных веток или явного слияния результатов; вся обработка последовательная.

## 4. Reflection
- **Наличие:** финализатор отделён от сканера и проверяет собранные evidence перед выдачей результата.
- **Пробелы:** нет триггеров включения/выключения рефлексии по риску/уверенности; нет ограниченного цикла «accept/reject+patch»; чек‑листы проверки не заданы.

## 5. Tool Use
- **Наличие:** все инструменты работают с сериализованными JSON‑ответами и компактными представлениями курсоров; базовая валидация параметров есть в сервисах.
- **Пробелы:** отсутствуют строгие схемы ввода/вывода и машинно‑читаемые ошибки; идемпотентность и корреляционные идентификаторы не описаны; защита от prompt‑injection при работе с внешними данными не реализована.

## 6. Planning
- **Наличие:** лимиты `CursorAgentLimits` задают границы шагов и размера пакетов.
- **Пробелы:** план не представлен как данные (нет state machine/checklist); не поддерживается replanning при новых данных; отсутствуют бюджеты по токенам/времени на шаги вне лимитов курсора.

## 7. Multi-Agent
- **Наличие:** выделены роли основного чат‑агента и потокового курсорного подагента в документации.
- **Пробелы:** нет протокола handoff с артефактами (цель, входы, риски); общий контекст не ограничивается ролями; координация агентов не описана.

## 8. Memory Management
- **Наличие:** локальные состояния курсора (`CursorAgentState`) и компрессия истории чата в `FunctionCallAwareChatHistoryCompressor`.
- **Пробелы:** нет политики записи/ttl между сессиями; нет разделения кратко/долго/рабочей памяти; защита от загрязнения инструкциями отсутствует.

## 9. Learning and Adaptation
- **Наличие:** не реализовано.
- **Пробелы:** нет сбора обратной связи, границ адаптации, офлайн‑eval перед rollout.

## 10. MCP
- **Наличие:** используется MCP‑подход: `EditorSession` держит документ и операции в памяти; инструменты экспонируются как плагины.
- **Пробелы:** нет явного реестра инструментов с версиями/правами; отсутствует изоляция или разрешения по агентам.

## 11. Goal Setting and Monitoring
- **Наличие:** шаги курсора логируются; лимиты шага и доказательств задают минимальные критерии останова.
- **Пробелы:** нет метрик успеха, трасс решений, мониторинга бюджетов или автоматических чеклистов выполнения цели.

## 12. Exception Handling and Recovery
- **Наличие:** базовые проверки аргументов и fail‑fast поведение в сервисах (валидация указателей, выброс исключений при некорректных операциях).
- **Пробелы:** нет классификации ошибок (retryable/fatal), компенсаций, circuit breaker для деградации LLM/инструментов.

## 13. Human-in-the-Loop
- **Наличие:** не описано.
- **Пробелы:** отсутствуют точки эскалации для рискованных действий, шаблоны запросов уточнений или валидации человеком.

## 14. RAG
- **Наличие:** не используется.
- **Пробелы:** нет чанкинга/метаданных, гибридного поиска, переранжирования, переписывания запросов или отбора контекста.

## 15. Prod-слой (A2A, оптимизация, безопасность, наблюдаемость)
- **Наличие:** логирование вызовов функций (`FunctionInvocationLoggingFilter`) и LLM‑запросов; лимиты курсоров предотвращают неограниченный контекст.
- **Пробелы:** нет протокола межагентных сообщений, бюджетирования ресурсов, guardrails/allowlist для инструментов, eval/алёртов, приоритезации и очередей.
