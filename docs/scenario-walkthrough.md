# Сценарии навигации по тестовым запросам

Документ описывает ожидаемые шаги работы системы для функциональных сценариев поиска по книге, используемых в текущих и закомментированных тестах. Описания основаны на коде потокового курса и подсказках в `SemanticKernelEngine`: один путь работы через создание курсора и последовательное чтение порций, предпочтение keyword-курсов для буквального поиска, широкие фильтры для структурных шаблонов и ответы с указанием семантического указателя. Подсказки должны оставаться общими и не подстраиваться под конкретные формулировки тестов.

## Общие принципы
- **Создание курсора.** Для буквальных запросов создавать keyword-курсор со стемами ключевых слов. Для структурных паттернов (диалоги, описания сцен) использовать обычный курсор с максимально широким фильтром, чтобы не пропустить релевантные абзацы.
- **Чтение порций.** Двигаться вперёд батчами через `chat_cursor_tools-read_cursor_batch`, учитывая лимиты по элементам и байтам из `CursorAgentLimits`. Фиксировать последний указатель батча, использовать его как маркер прогресса при продолжении.
- **Фильтрация.** Исключать заголовки, когда это явно требуется, по `LinearItemType`. Считать, что один абзац может содержать несколько упоминаний; если задача про “n‑е упоминание”, внутри абзаца учитывается только первая встреча термина.
- **Остановка.** Для “первого” и “второго” совпадения завершать обход сразу после нахождения нужного количества подтверждённых совпадений. Для “последнего” дочитывать курсор до конца, сохраняя последний увиденный указатель.
- **Ответ.** Формулировать итоги на русском, приводить семантический указатель и краткое пояснение/цитату. В сценариях с перефразированием — переписывать найденный абзац с добавлением требуемой детали, не применяя правок к документу.

## Сценарии поиска конкретных упоминаний
1. **Первое упоминание профессора Звёздочкина (без заголовков).**
   - Строим keyword-курсор со стемой фамилии (например, `["звездочкин"]`).
   - Читаем батчи по порядку, пропуская заголовки; первое совпадение в тексте даёт искомый указатель.
   - Возвращаем указатель и кратко подтверждаем содержимое абзаца.

2. **Второе упоминание профессора Звёздочкина (без заголовков).**
   - Аналогично пункту 1, но считаем попадания в текстовых элементах: первое фиксируем, второе завершает поиск.
   - Если в первом найденном абзаце несколько вхождений, считаем его единственным совпадением и ищем следующий абзац.

3. **Первое упоминание Пончика.**
   - Keyword-курсор с корнем `["пончик"]`.
   - Первое ненулевое совпадение в тексте фиксируем как ответ с указателем.

4. **Первое упоминание Фуксии.**
   - Keyword-курсор со стемой `["фукси"]`.
   - Первое совпадение в тексте (без заголовков) завершает обход.

5. **Первое совместное упоминание Фуксии и Селёдочки.**
   - Keyword-курсор с двумя стемами (например, `["фукси", "селедоч"]`), чтобы ловить абзацы, где встречаются обе фамилии.
   - Первое совпадение, где присутствуют обе строки, становится ответом; если курсор отдаёт только одно имя, продолжаем, пока не найдём совместное.
   - В ответе уточняем, кто персонажи, по контексту абзаца.

6. **Последнее упоминание Фуксии.**
   - Keyword-курсор `["фукси"]`.
   - Читаем все батчи до `HasMore=false`, обновляя “текущий” указатель каждый раз, когда встречаем имя; финальный сохранённый указатель возвращаем как последний.

7. **Первое появление профессора с описанием характера (“кипел от негодования”).**
   - Keyword-курсор `["звездочкин"]`; первый текстовый элемент с фамилией — кандидат.
   - Проверяем, что рядом есть описание эмоционального состояния/характера; если абзац содержит эти признаки, завершаем и сообщаем краткую характеристику.

8. **Упоминание язвительной реплики Знайки про “болтаться в центре Луны”.**
   - Используем keyword-курсор с корнями по ключевым словам сцены (`["болтал", "центр", "лун"]`) либо общий курсор с широкой выборкой абзацев, чтобы не пропустить варианты формулировки.
   - Идём по порядку, ищем диалоговый фрагмент с упоминанием центра Луны и адресацией к профессору; первый подходящий абзац даёт указатель.

## Сценарии поиска диалогов и сцен
1. **Первый диалог между двумя названными по имени персонажами.**
   - Создаём обычный курсор с максимально общим фильтром (например, “все абзацы”), чтобы видеть контекст целиком.
   - Читаем последовательные порции, отслеживая пары соседних абзацев с явными именами и репликами (форматы с тире, двоеточием или “имя сказал”).
   - Первый найденный фрагмент, где говорящие различимы по именам, фиксируем как ответ; указываем обоих персонажей и семантический указатель начальной реплики.

2. **Диалоговые/сценические вопросы про второе упоминание профессора (расширенные формулировки).**
   - Для варианта про “второе упоминание” повторяем стратегию keyword-курса и подсчёта, но дополнительно убеждаемся, что это не заголовок.
   - Для варианта с кратким пересказом характера после первого появления — используем пункт 7 в предыдущем разделе.

## Сценарии поиска описательных фрагментов
1. **Описание двух вращающихся зданий на улице Колокольчиков.**
   - Keyword-курсор со стемами ключевых существительных/прилагательных (`["здан", "спираль", "колокольчик", "колес"]`) без жёсткого совпадения полного текста.
   - Читаем первые совпадения, проверяем, что абзац описывает оба здания и их особенности; первый подходящий указатель — ответ.

2. **Перечень продукции одёжной фабрики (лифчики → шубы).**
   - Keyword-курсор по характерным товарам (`["фабрик", "лифт", "шуб"]` и др.) либо общий курсор с вниманием к перечислениям.
   - Первое совпадение с перечислением продукции фиксируем как ответ.

3. **Абзац, где Пончик топит костюмы в Огурцовой реке.**
   - Keyword-курсор с корнями `["пончик", "костюм", "огурцов"]`.
   - Первый абзац с этими деталями — ответ.

4. **Пояснение, почему от Пончика разбегались из-за нафталина.**
   - Keyword-курсор `["пончик", "нафталин"]`.
   - Находим абзац с описанием запаха и реакции окружающих, возвращаем его указатель и краткое пояснение.

5. **Сведения о том, что Знайка пробыл на Луне около четырёх часов и вернулся из-за воздуха.**
   - Keyword-курсор по ключевым словам (`["знайк", "час", "воздух"]`).
   - Первый абзац с обеими деталями — ответ.

6. **“Визуализация” лунного кратера как круглого поля с валом.**
   - Keyword-курсор `["кратер", "вал", "кругл", "пол"]`.
   - Ищем абзац с описанием формы и вала; первое попадание даёт указатель.

7. **Ссора астрономов (вулканисты vs метеоритчики).**
   - Keyword-курсор с корнями `["астроном", "вулкан", "метеорит"]`.
   - Находим абзац, где описано разделение на два лагеря, возвращаем указатель.

8. **Сравнение лунной поверхности с блином и упоминание пузырьков пара.**
   - Keyword-курсор `["блин", "пузыр", "пара"]`.
   - Первое совпадение, где есть и сравнение, и пояснение пузырьков, фиксируем как ответ.

## Сценарий переписывания абзаца
- **Добавить упоминание распускающихся яблонь в первом упоминании профессора.**
  - Находим первый абзац с фамилией через keyword-курсор, как в базовом сценарии.
  - Переписываем текст абзаца в ответе, добавляя нейтральную вставку про начало цветения яблонь, сохраняя исходный смысл и формат.
  - Возвращаем семантический указатель и обновлённый абзац в одном ответе; курсор можно останавливать сразу после первого совпадения.

## Потенциальные пробелы и риски
- По нескольким описательным сценам (вращающиеся здания, продукция фабрики) ключевые слова в запросах могут не совпадать с фактическим текстом; нужно подбирать нейтральные стемы и быть готовым дочитывать больше порций.
- При поиске “второго” упоминания для персонажа с частыми вхождениями важно явно отсекать заголовки и учитывать, что один абзац может содержать несколько повторов — счёт ведём по абзацам.
- Для диалогов критично держать широкий фильтр (иначе keyword-курсор может пропустить реплики без уникальных слов) и опираться на форму записи реплик, а не на конкретные имена.
- Подсказки в системном промпте должны оставаться универсальными (стратегии, фильтры, осторожность с подсчётом упоминаний) и не должны ссылаться на конкретные тестовые формулировки или ожидаемые указатели.
